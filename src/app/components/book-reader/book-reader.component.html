<div class="h-screen bg-gray-100 dark:bg-gray-900 flex flex-col">
    <!-- Loading State -->
    @if (loading) {
    <div class="flex-1 flex items-center justify-center">
        <div class="text-xl text-gray-600 dark:text-gray-400">
            Loading book...
        </div>
    </div>
    }

    <!-- Error State -->
    @if (error && !loading) {
    <div class="flex-1 flex items-center justify-center">
        <div class="text-xl text-red-600 dark:text-red-400">{{ error }}</div>
    </div>
    }

    <!-- Book Reader -->
    @if (book && !loading && !error) {
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm p-4 flex-shrink-0">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <button
                    (click)="backToLibrary()"
                    class="px-3 py-1 text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-md transition"
                >
                    ← Back to Library
                </button>
                <div class="flex-1 text-center">
                    <h1
                        class="text-2xl font-bold text-gray-800 dark:text-gray-100"
                    >
                        {{ book.title }}
                    </h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        {{ book.targetLanguage }} → {{ book.nativeLanguage }}
                    </p>
                </div>
                <div class="w-32"></div>
                <!-- Spacer for centering -->
            </div>
        </header>

        <!-- Page Content -->
        <main class="flex-1 overflow-y-auto p-8">
            <div
                class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-md p-8"
            >
                <div
                    class="mb-6 text-center text-sm text-gray-500 dark:text-gray-400"
                >
                    Page {{ currentPageIndex + 1 }} of {{ totalPages }}
                </div>

                <!-- Sentences -->
                <div class="space-y-0">
                    @for (sentence of currentPage?.sentences; track
                    sentence.target; let i = $index) {
                    <div
                        class="relative p-2 transition-colors duration-500 ease-in-out"
                        [class.bg-gray-800]="shouldShowNative(i) && !isDarkMode"
                        [class.bg-gray-100]="shouldShowNative(i) && isDarkMode"
                        [class.rounded-t-lg]="i === 0 && shouldShowNative(i)"
                        [class.rounded-b-lg]="
                            currentPage &&
                            i === currentPage.sentences.length - 1 &&
                            shouldShowNative(i)
                        "
                    >
                        <!-- Target Language (always visible) -->
                        <p
                            class="text-lg leading-relaxed transition-opacity duration-300 ease-in-out"
                            [class.text-gray-800]="!isDarkMode"
                            [class.dark:text-gray-200]="isDarkMode"
                            [class.opacity-0]="shouldShowNative(i)"
                        >
                            {{ sentence.target }}
                        </p>

                        <!-- Native Language (overlay with inverted color mode) -->
                        @if (shouldShowNative(i)) {
                        <p
                            class="absolute top-2 left-2 text-lg leading-relaxed font-medium transition-colors duration-500 ease-in-out"
                            [class.text-gray-200]="!isDarkMode"
                            [class.text-gray-800]="isDarkMode"
                        >
                            {{ sentence.native }}
                        </p>
                        }
                    </div>
                    }
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between items-center mt-8">
                    <button
                        (click)="previousPage()"
                        [disabled]="currentPageIndex === 0"
                        class="px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded-md hover:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-gray-300 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition"
                    >
                        ← Previous
                    </button>
                    
                    <!-- Set Progress Button -->
                    <button
                        (click)="openSetProgressModal()"
                        class="px-4 py-2 bg-green-600 dark:bg-green-500 text-white rounded-md hover:bg-green-700 dark:hover:bg-green-600 transition"
                    >
                        Set Progress
                    </button>
                    
                    <!-- Next or Next Chapter Button -->
                    @if (isLastPage() && isChapterContext && nextChapterId) {
                    <button
                        (click)="goToNextChapter()"
                        class="px-4 py-2 bg-purple-600 dark:bg-purple-500 text-white rounded-md hover:bg-purple-700 dark:hover:bg-purple-600 transition"
                    >
                        Next Chapter →
                    </button>
                    } @else {
                    <button
                        (click)="nextPage()"
                        [disabled]="currentPageIndex === totalPages - 1"
                        class="px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded-md hover:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-gray-300 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition"
                    >
                        Next →
                    </button>
                    }
                </div>
            </div>
        </main>

        <!-- Bottom Slider - Now Sticky -->
        <footer
            class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 shadow-lg flex-shrink-0"
        >
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-2">
                    <label class="block">
                        <span
                            class="text-sm font-medium text-gray-700 dark:text-gray-300"
                        >
                            Translation Level: {{ sliderValue }}%
                            <span
                                class="text-xs text-gray-500 dark:text-gray-400 ml-2"
                            >
                                (Use ↑↓ arrow keys to adjust by 5, ←→ to change
                                pages)
                            </span>
                        </span>
                    </label>
                    <button
                        (click)="toggleMaintainTranslationLevel()"
                        class="px-3 py-1 text-xs rounded-md border transition"
                        [class.bg-blue-600]="maintainTranslationLevel"
                        [class.dark:bg-blue-500]="maintainTranslationLevel"
                        [class.text-white]="maintainTranslationLevel"
                        [class.border-blue-600]="maintainTranslationLevel"
                        [class.dark:border-blue-500]="maintainTranslationLevel"
                        [class.bg-white]="!maintainTranslationLevel"
                        [class.dark:bg-gray-700]="!maintainTranslationLevel"
                        [class.text-gray-700]="!maintainTranslationLevel"
                        [class.dark:text-gray-300]="!maintainTranslationLevel"
                        [class.border-gray-300]="!maintainTranslationLevel"
                        [class.dark:border-gray-600]="!maintainTranslationLevel"
                        [class.hover:bg-blue-700]="maintainTranslationLevel"
                        [class.dark:hover:bg-blue-600]="
                            maintainTranslationLevel
                        "
                        [class.hover:bg-gray-50]="!maintainTranslationLevel"
                        [class.dark:hover:bg-gray-600]="
                            !maintainTranslationLevel
                        "
                        title="When enabled, translation level persists across pages. When disabled, it resets to 0% on each page change."
                    >
                        {{ maintainTranslationLevel ? "✓" : "" }} Maintain Level
                    </button>
                </div>
                <input
                    type="range"
                    min="0"
                    max="100"
                    step="1"
                    [(ngModel)]="sliderValue"
                    (input)="onSliderChange()"
                    class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-600 dark:accent-blue-500"
                />
                <div
                    class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1"
                >
                    <span>Target ({{ book.targetLanguage }})</span>
                    <span>Native ({{ book.nativeLanguage }})</span>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Set Progress Modal -->
    @if (showSetProgressModal) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">
                Set Progress
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">
                Mark page {{ currentPageIndex + 1 }} of {{ totalPages }} as your furthest read page?
            </p>
            <div class="flex justify-end space-x-3">
                <button
                    (click)="closeSetProgressModal()"
                    class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-400 dark:hover:bg-gray-700 transition"
                >
                    Cancel
                </button>
                <button
                    (click)="confirmSetProgress()"
                    class="px-4 py-2 bg-green-600 dark:bg-green-500 text-white rounded-md hover:bg-green-700 dark:hover:bg-green-600 transition"
                >
                    Confirm
                </button>
            </div>
        </div>
    </div>
    }
    }
</div>
